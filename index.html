<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>WebAR Ground Plane - A-Frame</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      renderer="colorManagement: true; physicallyCorrectLights"
      webxr="optionalFeatures: hit-test; requiredFeatures: hit-test;"
    >
      <!-- Camera -->
      <a-camera position="0 1.6 0"></a-camera>

      <!-- Lights -->
      <a-light type="directional" intensity="1" position="1 3 2"></a-light>
      <a-light type="ambient" intensity="0.5"></a-light>

      <!-- 3D Cube (hidden until placed) -->
      <a-box id="cube"
             color="tomato"
             scale="0.3 0.3 0.3"
             visible="false">
      </a-box>
    </a-scene>

    <script>
      // Wait until AR session starts
      AFRAME.scenes[0].renderer.xr.addEventListener("sessionstart", () => {
        const xrSession = AFRAME.scenes[0].renderer.xr.getSession();
        let viewerSpace = null;
        let refSpace = null;

        xrSession.requestReferenceSpace("viewer").then(space => {
          viewerSpace = space;
          return xrSession.requestReferenceSpace("local");
        }).then(space => {
          refSpace = space;
          return xrSession.requestHitTestSource({ space: viewerSpace });
        }).then(hitTestSource => {
          // Place cube on tap
          xrSession.addEventListener("select", ev => {
            xrSession.requestAnimationFrame((time, frame) => {
              const hitTestResults = frame.getHitTestResults(hitTestSource);
              if (hitTestResults.length > 0) {
                const pose = hitTestResults[0].getPose(refSpace);
                const cube = document.querySelector("#cube");
                cube.setAttribute("position", {
                  x: pose.transform.position.x,
                  y: pose.transform.position.y,
                  z: pose.transform.position.z
                });
                cube.setAttribute("visible", true);
              }
            });
          });
        });
      });
    </script>
  </body>
</html>
